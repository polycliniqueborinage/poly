<?php

	// Demarre une session
	session_start();

	include_once '../lib/fonctions.php';
	
	$dicoStatistique = array('COUNT(ta.id)' => 'Pourcentage de tarifications', 'COUNT(td.id)' => 'Pourcentage de prestations','SUM(td.cout_mutuelle)' => 'Pourcentage sur le gain','SUM(td.cout_medecin)' => 'Pourcentage sur le gain du medecin','SUM(td.cout_poly)' => 'Pourcentage sur le gain de la polyclinique' );
	$dicoGroupe = array('groupe1' => 'par medecin', 'groupe2' => 'par patient','groupe3' => 'par specialite' );
		
	
	// groupe
	$groupe = isset($_SESSION['stat_groupe']) ? $_SESSION['stat_groupe'] : "groupe1";
	$groupe = isset($_GET['stat_groupe']) ? $_GET['stat_groupe'] : $groupe;

	switch($groupe) {
			
		case "groupe1" :
			$groupe1 = "concat(me.nom, ' ', me.prenom)";
			$groupe2 = "me.inami";
		break;
		case "groupe2" :
			$groupe1 = "concat(pa.nom, ' ', pa.prenom)";
			$groupe2 = "pa.id";
		break;
		case "groupe3" :
			$groupe1 = "sp.specialite";
			$groupe2 = "sp.id";
		break;
	}
	
	// statistique
	$statistique = isset($_SESSION['stat_statistique']) ? $_SESSION['stat_statistique'] : "COUNT(ta.id)";
	$statistique = isset($_GET['stat_statistique']) ? $_GET['stat_statistique'] : $statistique;
	
	// nombre de resultat
	$statistique_number = isset($_SESSION['stat_statistique_number']) ? $_SESSION['stat_statistique_number'] : 10;
	$statistique_number = isset($_GET['stat_statistique_number']) ? $_GET['stat_statistique_number'] : $statistique_number;
	
	$jour = date("d");
	$mois = date("m");
	$annee = date("Y");
	$dataCurrent = date("Y-m-d", mktime(0, 0, 0, $mois - 1, $jour, $annee));
	
	$dateMin = isset($_SESSION['stat_date_min']) ? $_SESSION['stat_date_min'] : $dataCurrent;
	$dateMin = isset($_GET['stat_date_min']) ? $_GET['stat_date_min'] : $dateMin;
	
	// date de fin
	$dateMax = isset($_SESSION['stat_date_max']) ? $_SESSION['stat_date_max'] : date("Y-m-d");
	$dateMax = isset($_GET['stat_date_max']) ? $_GET['stat_date_max'] : $dateMax;
	
	$datetools1 = new dateTools($dateMin,$dateMin);
	$datetools2 = new dateTools($dateMax,$dateMax);
	
	
	$sqlglobal= "SELECT $groupe1 AS label, $statistique AS total
	FROM tarifications ta, tarifications_detail td, medecins me, patients pa, specialites sp
	WHERE ta.etat =  'close'
	AND ta.medecin_inami = me.inami
	AND ta.patient_id = pa.id
	AND td.tarification_id = ta.id
	AND sp.id = me.specialite
	AND ta.cloture >= '$dateMin' and ta.cloture <= '$dateMax' 
	GROUP BY $groupe2
	order by total desc
	LIMIT $statistique_number";
	
	//echo $sqlglobal;
	
	connexion_DB('poly');

	$result = requete_SQL ($sqlglobal);
	
	echo "<h1>".$dicoStatistique[$statistique]." ".$dicoGroupe[$groupe]." ( ".$datetools1->transformDATE2()." au ".$datetools2->transformDATE2().")</h1>";
	
	
	echo "<table border='0' cellpadding='2' cellspacing='1'>";
	
	while($data = mysql_fetch_assoc($result)) 	{
									
		echo "<tr onMouseOver='setPointer(this, 0, 0 );' onMouseOut='setPointer(this, 0, 1 );'>";
							
		echo "<td valign='top' bgcolor='#D5D5D5' align='center' nowrap='nowrap'>";
		echo htmlentities($data['label']);
		echo "</td>";

		echo "<td valign='top' bgcolor='#D5D5D5' align='center' nowrap='nowrap'>";
		echo round($data['total'],2);
		echo "</td>";
		
		echo "</tr>";
		
	}
	echo "</table>";
							
	
	deconnexion_DB();
	
	

?>